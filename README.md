# Mr.black - Финансовый трекер

Приложение для отслеживания финансов с Telegram-ботом.

## Структура проекта

Проект организован как монорепозиторий с двумя основными компонентами:

- **apps/server** - Backend API на Express.js с SQLite
- **apps/bot** - Telegram-бот для взаимодействия с пользователем

## Настройка и запуск

### Переменные окружения

Создайте файл `.env` в корне проекта со следующими переменными:

```
# Общие настройки
NODE_ENV=production
PORT=3000

# Настройки JWT
JWT_SECRET=ваш_секретный_ключ_jwt

# Настройки бота
BOT_TOKEN=ваш_токен_telegram_бота

# Настройки логирования
LOG_LEVEL=info
TELEGRAM_LOG_CHAT_ID=ваш_chat_id_для_логов
```

### Запуск с Docker

```bash
# Сборка и запуск контейнеров
docker-compose up -d

# Просмотр логов
docker-compose logs -f
```

### Запуск без Docker (для разработки)

```bash
# Установка зависимостей
pnpm install

# Запуск сервера
pnpm --filter @mr.black/server start

# Запуск бота (в отдельном терминале)
pnpm --filter @mr.black/bot start
```

## Система логирования

В проекте реализована комплексная система логирования с несколькими уровнями:

### Уровни логирования

- **error** - Критические ошибки, требующие немедленного внимания
- **warn** - Предупреждения, которые могут привести к проблемам
- **info** - Информационные сообщения о работе приложения
- **debug** - Подробная отладочная информация (только в режиме разработки)

### Хранение логов

Логи сохраняются в нескольких местах:

1. **Файловая система**:
   - `/logs/server-error.log` - Ошибки сервера
   - `/logs/server-combined.log` - Все логи сервера
   - `/logs/bot-error.log` - Ошибки бота
   - `/logs/bot-combined.log` - Все логи бота

2. **Telegram**:
   - Критические ошибки (уровень error) отправляются в указанный Telegram-чат
   - Для настройки укажите `TELEGRAM_LOG_CHAT_ID` в переменных окружения

### Настройка уровня логирования

Уровень логирования можно настроить через переменную окружения `LOG_LEVEL`:
- `error` - только ошибки
- `warn` - ошибки и предупреждения
- `info` - ошибки, предупреждения и информационные сообщения (по умолчанию)
- `debug` - все сообщения, включая отладочную информацию

## Безопасность

- Все API-эндпоинты защищены JWT-аутентификацией
- Пароли и чувствительные данные не хранятся в открытом виде
- Логи с чувствительной информацией не отправляются в Telegram

## Резервное копирование

База данных SQLite хранится в томе Docker и доступна по пути `/db/mr.black.db`. Рекомендуется настроить регулярное резервное копирование этого файла.

## Устранение неполадок

### Проблемы с SQLite на Raspberry Pi

Если вы столкнулись с ошибками при работе с SQLite на Raspberry Pi, проверьте:

1. Версию Node.js (рекомендуется 14.x для Raspberry Pi 3B+)
2. Наличие необходимых системных зависимостей:
   ```bash
   sudo apt-get update
   sudo apt-get install -y python3 make g++ gcc
   ```

### Проблемы с логированием

Если логи не отправляются в Telegram:

1. Проверьте правильность `BOT_TOKEN` и `TELEGRAM_LOG_CHAT_ID`
2. Убедитесь, что бот добавлен в указанный чат
3. Проверьте права бота на отправку сообщений
